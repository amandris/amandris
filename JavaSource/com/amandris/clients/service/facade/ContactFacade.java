package com.amandris.clients.service.facade;import java.util.ArrayList;import java.util.Collection;import java.util.GregorianCalendar;import java.util.Iterator;import java.util.Locale;import com.amandris.clients.service.dao.BuyerDAO;import com.amandris.clients.service.dao.CalendarDAO;import com.amandris.clients.service.dao.ContactDAO;import com.amandris.clients.service.dao.ContactMessageDAO;import com.amandris.clients.service.dao.InvitationDAO;import com.amandris.clients.service.dao.SellerDAO;import com.amandris.clients.service.dao.UtilDAO;import com.amandris.clients.service.vo.Buyer;import com.amandris.clients.service.vo.Calendar;import com.amandris.clients.service.vo.Contact;import com.amandris.clients.service.vo.ContactMessage;import com.amandris.clients.service.vo.Invitation;import com.amandris.clients.service.vo.Seller;import com.amandris.clients.util.ConfigurationParameterManager;import com.amandris.clients.util.Constant;import com.amandris.clients.util.DBUtils;import com.amandris.clients.util.exception.DataAccessErrorException;import com.amandris.clients.util.exception.DataUpdateErrorException;import com.amandris.clients.util.exception.TranslateValueObjectErrorException;import com.amandris.clients.util.mail.ContactCancelledMailObject;import com.amandris.clients.util.mail.ContactMailObject;import com.amandris.clients.util.mail.ContactReplyMailObject;import com.amandris.clients.util.mail.Mail;import com.amandris.clients.util.mail.PaymentDoneMailObject;import com.amandris.clients.util.translator.ContactToSellerContactViewTranslator;import com.amandris.clients.util.translator.TranslatorFactory;import com.amandris.clients.web.form.CancelDateForm;import com.amandris.clients.web.form.SellerReplyContactForm;import com.amandris.clients.web.util.BuyerSession;import com.amandris.clients.web.util.SellerSession;import com.amandris.clients.web.view.BuyerConfirmContactView;import com.amandris.clients.web.view.BuyerContactView;import com.amandris.clients.web.view.ContactDataView;import com.amandris.clients.web.view.ContactMessageView;import com.amandris.clients.web.view.SellerContactView;public class ContactFacade {		public boolean setContact( BuyerConfirmContactView buyerConfirmContactView, Integer buyerId, boolean sendMail, Locale locale) throws DataAccessErrorException, DataUpdateErrorException	{		ContactDAO				contactDAO					= new ContactDAO();		ContactMessageDAO		contactMessageDAO			= new ContactMessageDAO();		BuyerDAO				buyerDAO					= new BuyerDAO();		SellerDAO				sellerDAO					= new SellerDAO();		UtilDAO					utilDAO						= new UtilDAO();		CalendarDAO				calendarDAO					= new CalendarDAO();		InvitationDAO			invitationDAO				= new InvitationDAO();		Collection				collection					= null;		Iterator				iterator					= null;		Contact					contact						= new Contact();		Invitation				invitation					= null;		ContactMessage			contactMessage				= new ContactMessage();		Calendar				calendar					= null;		Buyer					buyer						= null;		Seller					seller						= null;		ContactMailObject		contactMailObject			= new ContactMailObject( locale);					buyer 	= buyerDAO.getBuyerById( buyerId, null);		seller 	= sellerDAO.getSellerById( DBUtils.parseInteger( buyerConfirmContactView.getSellerId(), 0));				if( ( buyer == null) || ( seller == null))			return false;				collection = calendarDAO.getCalendarBySellerIdDateAndLength( seller.getId(), buyerConfirmContactView.getJavaDate(), DBUtils.parseInteger( buyerConfirmContactView.getLength(), 0).intValue());		iterator = collection.iterator();				while( iterator.hasNext()) {			calendar = ( Calendar) iterator.next();						if( calendar.getHourStatusConst().intValue() != Constant.HOUR_STATUS_FREE)				return false;						calendar.setHourStatusConst( new Integer( Constant.HOUR_STATUS_DATE));		}				contact.setSellerActive			( new Integer( 1));		contact.setBuyerActive			( new Integer( 1));		contact.setAddress1				( buyerConfirmContactView.getAddress1());		contact.setAddress2				( buyerConfirmContactView.getAddress2());		contact.setBuyer				( buyer);		contact.setBuyerId				( buyerId);		contact.setCancelDateText		( "");		contact.setCity					( buyerConfirmContactView.getCity());		contact.setContactDate			( GregorianCalendar.getInstance( locale).getTime());		contact.setCurrencyConst		( DBUtils.parseInteger( buyerConfirmContactView.getCurrencyConst(), 0));		contact.setDateDate				( buyerConfirmContactView.getJavaDate());		contact.setDateStatusConst		( new Integer( Constant.DATE_STATUS_NA));		contact.setLength				( DBUtils.parseInteger( buyerConfirmContactView.getLength(), 0));		contact.setMessageAnswer		( "");		contact.setMessageStatusConst	( new Integer( Constant.MESSAGE_STATUS_WAITING));		contact.setPaymentStatusConst	( new Integer( Constant.PAYMENT_STATUS_NA));		contact.setPostalCode			( "");		contact.setPrice				( buyerConfirmContactView.getPriceDouble());		contact.setSeller				( seller);		contact.setSellerId				( seller.getId());		contact.setServiceTypeConst		( DBUtils.parseInteger( buyerConfirmContactView.getServiceTypeConst(), 0));		contact.setState				( buyerConfirmContactView.getState());		contact.setCountry				( buyerConfirmContactView.getCountry());		contact.setVoteStatusConst		( new Integer( Constant.VOTE_STATUS_NA));		contact.setSellerVoteStatusConst( new Integer( Constant.VOTE_STATUS_NA));		contact.setBuyerMadePayment		( new Integer( 0));		contactDAO.setContact( contact);				if( buyerConfirmContactView.getUsingInvitationFreeContact().equals( "1")) {			invitation = invitationDAO.getInvitationById( DBUtils.parseInteger( buyerConfirmContactView.getInvitationId(), 0));			if( invitation != null ) {				invitation.setFreeContactUsed( new Integer( 1));								invitationDAO.setInvitation( invitation);			}		}				buyer.setContactsSent( new Integer( buyer.getContactsSent().intValue() + 1));		buyerDAO.setBuyer( buyer);		if( !buyerConfirmContactView.getText().trim().equals( "")) {			contactMessage.setContact		( contact);			contactMessage.setContactId		( contact.getId());			contactMessage.setDate			( contact.getContactDate());			contactMessage.setIsNew			( new Integer( 1));			contactMessage.setSentFromBuyer	( new Integer( 1));			contactMessage.setText			( buyerConfirmContactView.getText());						contactMessageDAO.setContactMessage( contactMessage);		}				iterator = collection.iterator();				while( iterator.hasNext()) {			calendar = ( Calendar) iterator.next();						calendarDAO.setCalendar( calendar);		}				seller.setContactsReceived( new Integer( seller.getContactsReceived().intValue() + 1));				sellerDAO.setSeller( seller);				if( sendMail) {			contactMailObject.setDate	( DBUtils.getDate( contact.getDateDate(), 4));			contactMailObject.setId		( buyer.getId().toString());			contactMailObject.setLogin	( buyer.getLogin());			contactMailObject.setText	( contactMessage.getText());			contactMailObject.setSeller	( seller.getLogin());						if( buyer.getIsPublic().intValue() == 1)				contactMailObject.setIsPublic( true);			else				contactMailObject.setIsPublic( false);						String text = ConfigurationParameterManager.getMessages().getMessage( locale, "contactMailObject.subject", seller.getLogin());						Mail.sendMail( seller.getEmail(), text, contactMailObject);		}				return true;	}		public boolean setSellerReplyContact( SellerReplyContactForm sellerReplyContactForm, Integer sellerId, boolean sendMail, Locale locale) throws DataAccessErrorException, DataUpdateErrorException	{		ContactDAO				contactDAO					= new ContactDAO();		BuyerDAO				buyerDAO					= new BuyerDAO();		SellerDAO				sellerDAO					= new SellerDAO();		Contact					contact						= new Contact();		Buyer					buyer						= null;		Seller					seller						= null;		ContactReplyMailObject	contactReplyMailObject		= new ContactReplyMailObject( locale);					contact	= contactDAO.getContactById	( DBUtils.parseInteger( sellerReplyContactForm.getContactId(), 0));		buyer	= buyerDAO.getBuyerById		( DBUtils.parseInteger( sellerReplyContactForm.getBuyerId(), 0), null);		seller 	= sellerDAO.getSellerById	( DBUtils.parseInteger( sellerReplyContactForm.getSellerId(), 0));		if( ( contact.getBuyerId().intValue() != buyer.getId().intValue()) || ( contact.getSellerId().intValue() != seller.getId().intValue()))			return false;				if ( contact.getMessageStatusConst().intValue() != Constant.MESSAGE_STATUS_WAITING)			return false;				if( seller.getId().intValue() != sellerId.intValue())			return false;				if( sellerReplyContactForm.getReply().equals( "1")){			contact.setMessageAnswer		( "");			contact.setMessageStatusConst	( new Integer( Constant.MESSAGE_STATUS_ACCEPTED));						if( contact.getPrice().doubleValue() == 0){				contact.setPaymentStatusConst( new Integer( Constant.PAYMENT_STATUS_NOT_NEEDED));				contact.setDateStatusConst	 ( new Integer( Constant.DATE_STATUS_WAITING));			}else {				if( seller.getPaymentBeforeDate().intValue() == 1){					contact.setPaymentStatusConst( new Integer( Constant.PAYMENT_STATUS_WAITING));				} else {					contact.setPaymentStatusConst( new Integer( Constant.PAYMENT_STATUS_NOT_NEEDED));					contact.setDateStatusConst	 ( new Integer( Constant.DATE_STATUS_WAITING));				}			}							contact.setMessageStatusConst	( new Integer( Constant.MESSAGE_STATUS_ACCEPTED));			seller.setContactsAccepted		( new Integer( seller.getContactsAccepted().intValue() + 1));			buyer.setContactsAccepted		( new Integer( buyer.getContactsAccepted().intValue() + 1));		} else if( sellerReplyContactForm.getReply().equals( "2")){			contact.setMessageAnswer		( sellerReplyContactForm.getText());			contact.setMessageStatusConst	( new Integer( Constant.MESSAGE_STATUS_REJECTED));			seller.setContactsRejected		( new Integer( seller.getContactsRejected().intValue() + 1));			buyer.setContactsRejected		( new Integer( buyer.getContactsRejected().intValue() + 1));		}		contactDAO.setContact	( contact);		sellerDAO.setSeller		( seller);		buyerDAO.setBuyer		( buyer);				if( sendMail) {			contactReplyMailObject.setDate	( DBUtils.getDate( contact.getDateDate(), 4));			contactReplyMailObject.setId	( seller.getId().toString());			contactReplyMailObject.setLogin	( seller.getLogin());						if( contact.getMessageStatusConst().intValue() == Constant.MESSAGE_STATUS_ACCEPTED)				contactReplyMailObject.setIsAccepted( true);			else				contactReplyMailObject.setIsAccepted( false);						String text = ConfigurationParameterManager.getMessages().getMessage( locale, "contactReplyMailObject.subject", seller.getLogin());						Mail.sendMail( buyer.getEmail(), text, contactReplyMailObject);		}						return true;	}		public boolean deleteBuyerContactById( Integer id, Integer buyerId) throws DataUpdateErrorException, DataAccessErrorException	{		ContactDAO 	contactDAO 	= new ContactDAO();		Contact		contact		= null;		boolean		allowed		= false;				contact = contactDAO.getContactById( id);				if( contact == null)			return false;				if( contact.getBuyerId().intValue() != buyerId.intValue())			return false;						if( ( contact.getVoteStatusConst().intValue() == Constant.VOTE_STATUS_DONE) ||			( contact.getMessageStatusConst().intValue() == Constant.MESSAGE_STATUS_REJECTED) ||			( contact.getMessageStatusConst().intValue() == Constant.MESSAGE_STATUS_NOT_REPLIED))			allowed = true;			if( allowed) {			contact.setBuyerActive( new Integer( 0));			contactDAO.setContact( contact);						return true;		} 				return false;	}		public boolean deleteSellerContactById( Integer id, Integer sellerId) throws DataUpdateErrorException, DataAccessErrorException	{		ContactDAO 	contactDAO 	= new ContactDAO();		Contact		contact		= null;		boolean		allowed		= false;				contact = contactDAO.getContactById( id);				if( contact == null)			return false;				if( contact.getSellerId().intValue() != sellerId.intValue())			return false;						if( ( contact.getSellerVoteStatusConst().intValue() == Constant.VOTE_STATUS_DONE) ||			( contact.getMessageStatusConst().intValue() == Constant.MESSAGE_STATUS_REJECTED) ||			( contact.getMessageStatusConst().intValue() == Constant.MESSAGE_STATUS_NOT_REPLIED))			allowed = true;			if( allowed) {			contact.setSellerActive( new Integer( 0));			contactDAO.setContact( contact);						return true;		} 				return false;					}		public boolean cancelDate( CancelDateForm cancelDateForm, Integer userId, boolean isSeller, boolean sendMail, Locale locale) throws DataAccessErrorException, DataUpdateErrorException	{		ContactDAO					contactDAO					= new ContactDAO();		CalendarDAO					calendarDAO					= new CalendarDAO();		SellerDAO					sellerDAO					= new SellerDAO();		BuyerDAO					buyerDAO					= new BuyerDAO();		Contact						contact						= null;		Calendar					calendar					= null;		Collection					collection					= null;		ContactCancelledMailObject 	contactCancelledMailObject 	= new ContactCancelledMailObject( locale);		String						text						= "";				contact = contactDAO.getContactById( DBUtils.parseInteger( cancelDateForm.getContactId(), 0));				if( contact == null)			return false;				if( isSeller) {			if( contact.getSellerId().intValue() != userId.intValue())				return false;		} else {			if( contact.getBuyerId().intValue() != userId.intValue())				return false;		}				if( ( contact.getMessageStatusConst().intValue() != Constant.MESSAGE_STATUS_ACCEPTED) ||			( contact.getDateStatusConst().intValue() != Constant.DATE_STATUS_WAITING))			return false;				contact.setDateStatusConst		( new Integer( Constant.DATE_STATUS_CANCELED));		contact.setVoteStatusConst		( new Integer( Constant.VOTE_STATUS_WAITING));		contact.setSellerVoteStatusConst( new Integer( Constant.VOTE_STATUS_WAITING));		contact.setCancelDateText		( DBUtils.controlNull( cancelDateForm.getText()));				if( contact.getPaymentStatusConst().intValue() == Constant.PAYMENT_STATUS_WAITING)			contact.setPaymentStatusConst( new Integer( Constant.PAYMENT_STATUS_NOT_DONE));				contactDAO.setContact( contact);				if( isSeller) {			contact.getSeller().setDatesCanceled( new Integer( contact.getSeller().getDatesCanceled().intValue() + 1));			sellerDAO.setSeller( contact.getSeller());		} else {			contact.getBuyer().setDatesCanceled( new Integer( contact.getBuyer().getDatesCanceled().intValue() + 1));			buyerDAO.setBuyer( contact.getBuyer());		}				collection = calendarDAO.getCalendarBySellerIdDateAndLength( contact.getSellerId(), contact.getDateDate(), contact.getLength().intValue());				Iterator iterator = collection.iterator();				while( iterator.hasNext()) {			calendar = ( Calendar) iterator.next();						calendar.setHourStatusConst( new Integer( Constant.HOUR_STATUS_FREE));						calendarDAO.setCalendar( calendar);		}				if( sendMail) {			contactCancelledMailObject.setDate	( DBUtils.getDate( contact.getDateDate(), 4));						if( isSeller) {				contactCancelledMailObject.setId				( contact.getSeller().getId().toString());				contactCancelledMailObject.setLogin				( contact.getSeller().getLogin());				contactCancelledMailObject.setOtherUserLogin	( contact.getBuyer().getLogin());			} else {				contactCancelledMailObject.setId				( contact.getBuyer().getId().toString());				contactCancelledMailObject.setLogin				( contact.getBuyer().getLogin());				contactCancelledMailObject.setOtherUserLogin	( contact.getSeller().getLogin());			}					contactCancelledMailObject.setIsSeller( isSeller);						if( isSeller) {				text = ConfigurationParameterManager.getMessages().getMessage( locale, "contactCancelledMailObject.subject", contact.getBuyer().getLogin(), contact.getSeller().getLogin());				Mail.sendMail( contact.getBuyer().getEmail(), text, contactCancelledMailObject);			} else {				text = ConfigurationParameterManager.getMessages().getMessage( locale, "contactCancelledMailObject.subject", contact.getSeller().getLogin(), contact.getBuyer().getLogin());				Mail.sendMail( contact.getSeller().getEmail(), text, contactCancelledMailObject);			}		}				return true;	}		public boolean setBuyerMadePayment( Integer contactId, Integer buyerId, boolean sendMail, Locale locale) throws DataAccessErrorException, DataUpdateErrorException	{		ContactDAO				contactDAO				= new ContactDAO();		Contact					contact					= null;		PaymentDoneMailObject	paymentDoneMailObject	= new PaymentDoneMailObject( locale);					contact = contactDAO.getContactById( contactId);				if( contact == null)			return false;				if( contact.getBuyerId().intValue() != buyerId.intValue())			return false;				contact.setBuyerMadePayment( new Integer( 1));				contactDAO.setContact( contact);				if( sendMail) {			if( sendMail) {				paymentDoneMailObject.setId			( contact.getBuyer().getId().toString());				paymentDoneMailObject.setLogin		( contact.getBuyer().getLogin());				paymentDoneMailObject.setIsPublic	( ( contact.getBuyer().getIsPublic().intValue() == 1 ? true : false));								String text = ConfigurationParameterManager.getMessages().getMessage( locale, "paymentDoneMailObject.subject", contact.getBuyer().getLogin());								Mail.sendMail( contact.getSeller().getEmail(), text, paymentDoneMailObject);			}		}				return true;	}		public boolean setSellerMarkAsPay( Integer contactId, Integer sellerId, Locale locale) throws DataAccessErrorException, DataUpdateErrorException	{		ContactDAO			contactDAO			= new ContactDAO();		Contact				contact				= null;				contact = contactDAO.getContactById( contactId);				if( contact == null)			return false;				if( contact.getSellerId().intValue() != sellerId.intValue())			return false;				contact.setBuyerMadePayment		( new Integer( 1));		contact.setPaymentStatusConst	( new Integer( Constant.PAYMENT_STATUS_DONE));		contact.setDateStatusConst		( new Integer( Constant.DATE_STATUS_WAITING));				contactDAO.setContact( contact);				return true;	}		public BuyerContactView getBuyerContactById( Integer id, BuyerSession buyerSession, Locale locale) throws DataAccessErrorException, TranslateValueObjectErrorException	{		ContactDAO 			contactDAO 					= new ContactDAO();		ContactMessageDAO 	contactMessageDAO			= new ContactMessageDAO();		Contact				contact						= null;		BuyerContactView 	buyerContactView 			= null;		Collection			contactMessageCollection	= null;		Iterator			contactMessageIterator		= null;		ArrayList			contactMessageList			= new ArrayList();		ContactMessage		contactMessage				= null;		ContactMessageView	contactMessageView			= null;				contact = contactDAO.getContactById( id);				if( contact == null)			return null;				if( contact.getBuyerId().intValue() != buyerSession.getId().intValue())			return null;				buyerContactView = ( BuyerContactView) TranslatorFactory.getTranslator( contact, locale).translateView();				contactMessageCollection = contactMessageDAO.getContactMessageByContactId( id);				if(( contactMessageCollection != null) && ( contactMessageCollection.size() != 0)) {			contactMessageIterator = contactMessageCollection.iterator();						while( contactMessageIterator.hasNext()) {				contactMessage = (ContactMessage) contactMessageIterator.next();								contactMessageView = ( ContactMessageView) TranslatorFactory.getTranslator( contactMessage, locale).translateView();								contactMessageList.add( contactMessageView);			}		}				buyerContactView.setContactMessage( contactMessageList);				return buyerContactView;			}		public SellerContactView getSellerContactById( Integer id, SellerSession sellerSession, Locale locale) throws DataAccessErrorException, TranslateValueObjectErrorException	{		ContactDAO 			contactDAO 					= new ContactDAO();		ContactMessageDAO 	contactMessageDAO			= new ContactMessageDAO();		Contact				contact						= null;		SellerContactView 	sellerContactView 			= null;		Collection			contactMessageCollection	= null;		Iterator			contactMessageIterator		= null;		ArrayList			contactMessageList			= new ArrayList();		ContactMessage		contactMessage				= null;		ContactMessageView	contactMessageView			= null;				contact = contactDAO.getContactById( id);				if( contact == null)			return null;				if( contact.getSellerId().intValue() != sellerSession.getId().intValue())			return null;				ContactToSellerContactViewTranslator contactToSellerContactViewTranslator = new ContactToSellerContactViewTranslator();		contactToSellerContactViewTranslator.setLocale( locale);		contactToSellerContactViewTranslator.setObject( contact);				sellerContactView = ( SellerContactView) contactToSellerContactViewTranslator.translateView();				contactMessageCollection = contactMessageDAO.getContactMessageByContactId( id);				if(( contactMessageCollection != null) && ( contactMessageCollection.size() != 0)) {			contactMessageIterator = contactMessageCollection.iterator();						while( contactMessageIterator.hasNext()) {				contactMessage = (ContactMessage) contactMessageIterator.next();												contactMessageView = ( ContactMessageView) TranslatorFactory.getTranslator( contactMessage, locale).translateView();								contactMessageList.add( contactMessageView);			}		}				sellerContactView.setContactMessage( contactMessageList);				return sellerContactView;			}		public boolean existsSellerContactBySellerIdAndBuyerId( Integer sellerId, Integer buyerId,  Locale locale) throws DataAccessErrorException, TranslateValueObjectErrorException	{		ContactDAO 			contactDAO 					= new ContactDAO();		Contact				contact						= null;				contact = contactDAO.getContactBySellerIdAndBuyerId( sellerId, buyerId);				if( contact == null)			return false;				return true;	}			public SellerContactView getSellerContactBySellerIdAndBuyerId( Integer sellerId, Integer buyerId,  Locale locale) throws DataAccessErrorException, TranslateValueObjectErrorException	{		ContactDAO 			contactDAO 					= new ContactDAO();		ContactMessageDAO 	contactMessageDAO			= new ContactMessageDAO();		Contact				contact						= null;		SellerContactView 	sellerContactView 			= null;		Collection			contactMessageCollection	= null;		Iterator			contactMessageIterator		= null;		ArrayList			contactMessageList			= new ArrayList();		ContactMessage		contactMessage				= null;		ContactMessageView	contactMessageView			= null;				contact = contactDAO.getContactBySellerIdAndBuyerId( sellerId, buyerId);				if( contact == null)			return null;				ContactToSellerContactViewTranslator contactToSellerContactViewTranslator = new ContactToSellerContactViewTranslator();		contactToSellerContactViewTranslator.setLocale( locale);		contactToSellerContactViewTranslator.setObject( contact);				sellerContactView = ( SellerContactView) contactToSellerContactViewTranslator.translateView();				contactMessageCollection = contactMessageDAO.getContactMessageByContactId( contact.getId());				if(( contactMessageCollection != null) && ( contactMessageCollection.size() != 0)) {			contactMessageIterator = contactMessageCollection.iterator();						while( contactMessageIterator.hasNext()) {				contactMessage = (ContactMessage) contactMessageIterator.next();												contactMessageView = ( ContactMessageView) TranslatorFactory.getTranslator( contactMessage, locale).translateView();								contactMessageList.add( contactMessageView);			}		}				sellerContactView.setContactMessage( contactMessageList);				return sellerContactView;			}		public ContactDataView getBuyerContactDataByBuyerId( Integer buyerId, int startIndex, int offset, Locale locale) throws DataAccessErrorException, DataUpdateErrorException, TranslateValueObjectErrorException	{				ContactDAO				contactDAO				= new ContactDAO();		SellerDAO				sellerDAO				= new SellerDAO();		BuyerDAO				buyerDAO				= new BuyerDAO();		Contact					contact					= null;		Iterator				buyerContactIterator	= null;		ContactDataView			buyerContactDataView	= new ContactDataView();		BuyerContactView		buyerContactView		= null;		ArrayList				list					= new ArrayList();		boolean 				odd						= true;		boolean 				statusChanged			= false;				buyerContactDataView.setTotalContacts		( Integer.toString( contactDAO.getBuyerContactCount( buyerId)));		buyerContactDataView.setWaitingContacts		( Integer.toString( contactDAO.getBuyerContactCount( buyerId, Constant.MESSAGE_STATUS_WAITING, 	Constant.MESSAGE_STATUS_NA, 		Constant.MESSAGE_STATUS_NA, 	Constant.MESSAGE_STATUS_NA)));		buyerContactDataView.setWaitingPayments		( Integer.toString( contactDAO.getBuyerContactCount( buyerId, Constant.PAYMENT_STATUS_NA, 		Constant.PAYMENT_STATUS_WAITING, 	Constant.PAYMENT_STATUS_NA, 	Constant.PAYMENT_STATUS_NA)));		buyerContactDataView.setWaitingDates		( Integer.toString( contactDAO.getBuyerContactCount( buyerId, Constant.DATE_STATUS_NA, 			Constant.DATE_STATUS_NA, 			Constant.DATE_STATUS_WAITING, 	Constant.DATE_STATUS_NA)));		buyerContactDataView.setWaitingVotes		( Integer.toString( contactDAO.getBuyerContactCount( buyerId, Constant.VOTE_STATUS_NA, 			Constant.VOTE_STATUS_NA, 			Constant.VOTE_STATUS_NA, 		Constant.VOTE_STATUS_WAITING)));		buyerContactIterator = contactDAO.getBuyerContact( buyerId, "dateDate", false, startIndex, offset).iterator();		while( buyerContactIterator.hasNext()) {			contact 			= ( Contact) buyerContactIterator.next();			buyerContactView 	= new BuyerContactView();			statusChanged		= false;									//Si la fecha de la cita se ha sobrepasado, dependiendo de si habia			//que realizar un pago se pone la cita como realizada o no realizada			//Si aún no se había contestado a la petición de cita se pone todo a not done			//El estado del voto se pone a pendiente			if( DBUtils.getTimeFrom( contact.getDateDate(), locale, false) <= 0) {				if ( contact.getPaymentStatusConst().intValue() == Constant.PAYMENT_STATUS_WAITING) {					contact.setPaymentStatusConst	( new Integer( Constant.PAYMENT_STATUS_NOT_DONE));					contact.setDateStatusConst		( new Integer( Constant.DATE_STATUS_NOT_DONE));					contact.setVoteStatusConst		( new Integer( Constant.VOTE_STATUS_WAITING));					contact.setSellerVoteStatusConst( new Integer( Constant.VOTE_STATUS_WAITING));					statusChanged = true;				}								if(( contact.getPaymentStatusConst().intValue() == Constant.PAYMENT_STATUS_DONE) ||				   ( contact.getPaymentStatusConst().intValue() == Constant.PAYMENT_STATUS_NOT_NEEDED)) { 						if( ( contact.getDateStatusConst().intValue() == Constant.DATE_STATUS_WAITING) || ( contact.getDateStatusConst().intValue() == Constant.DATE_STATUS_NA)) {							contact.setDateStatusConst( new Integer( Constant.DATE_STATUS_DONE));							statusChanged = true;						}												if( contact.getVoteStatusConst().intValue() == Constant.VOTE_STATUS_NA) {							contact.setVoteStatusConst		( new Integer( Constant.VOTE_STATUS_WAITING));							contact.setSellerVoteStatusConst( new Integer( Constant.VOTE_STATUS_WAITING));							statusChanged = true;						}				}								if( contact.getPaymentStatusConst().intValue() == Constant.PAYMENT_STATUS_NA){						contact.setMessageStatusConst( new Integer( Constant.MESSAGE_STATUS_NOT_REPLIED));						contact.setDateStatusConst( new Integer( Constant.DATE_STATUS_NOT_DONE));						contact.setPaymentStatusConst( new Integer( Constant.PAYMENT_STATUS_NOT_DONE));						contact.setVoteStatusConst( new Integer( Constant.VOTE_STATUS_NA));						contact.setVoteStatusConst( new Integer( Constant.VOTE_STATUS_NA));						statusChanged = true;												contact.getSeller().setContactsNotReplied( new Integer( contact.getSeller().getContactsNotReplied().intValue() + 1));						sellerDAO.setSeller( contact.getSeller());												contact.getBuyer().setContactsNotReplied( new Integer( contact.getBuyer().getContactsNotReplied().intValue() + 1));						buyerDAO.setBuyer( contact.getBuyer());				}								if( statusChanged == true)					contactDAO.setContact( contact);			}									buyerContactView = ( BuyerContactView) TranslatorFactory.getTranslator( contact, locale).translateView();						if( odd)				buyerContactView.setOddOrEven( "odd");			else				buyerContactView.setOddOrEven( "even");						odd = ! odd;						list.add( buyerContactView);					}					buyerContactDataView.setContacts( list);				return buyerContactDataView;	}		public ContactDataView getSellerContactDataBySellerId( Integer sellerId, int startIndex, int offset, Locale locale) throws DataAccessErrorException, DataUpdateErrorException, TranslateValueObjectErrorException	{				ContactDAO				contactDAO				= new ContactDAO();		SellerDAO				sellerDAO				= new SellerDAO();		BuyerDAO				buyerDAO				= new BuyerDAO();		Contact					contact					= null;		Iterator				sellerContactIterator	= null;		ContactDataView			sellerContactDataView	= new ContactDataView();		SellerContactView		sellerContactView		= null;		ArrayList				list					= new ArrayList();		boolean 				odd						= true;		boolean 				statusChanged			= false;				sellerContactDataView.setTotalContacts		( Integer.toString( contactDAO.getSellerContactCount( sellerId)));		sellerContactDataView.setWaitingContacts	( Integer.toString( contactDAO.getSellerContactCount( sellerId, Constant.MESSAGE_STATUS_WAITING, 	Constant.MESSAGE_STATUS_NA, 		Constant.MESSAGE_STATUS_NA, 	Constant.MESSAGE_STATUS_NA)));		sellerContactDataView.setWaitingPayments	( Integer.toString( contactDAO.getSellerContactCount( sellerId, Constant.PAYMENT_STATUS_NA, 		Constant.PAYMENT_STATUS_WAITING, 	Constant.PAYMENT_STATUS_NA, 	Constant.PAYMENT_STATUS_NA)));		sellerContactDataView.setWaitingDates		( Integer.toString( contactDAO.getSellerContactCount( sellerId, Constant.DATE_STATUS_NA, 			Constant.DATE_STATUS_NA, 			Constant.DATE_STATUS_WAITING, 	Constant.DATE_STATUS_NA)));		sellerContactDataView.setWaitingVotes		( Integer.toString( contactDAO.getSellerContactCount( sellerId, Constant.VOTE_STATUS_NA, 			Constant.VOTE_STATUS_NA, 			Constant.VOTE_STATUS_NA, 		Constant.VOTE_STATUS_WAITING)));		sellerContactIterator = contactDAO.getSellerContact( sellerId, "dateDate", false, startIndex, offset).iterator();		while( sellerContactIterator.hasNext()) {			contact 			= ( Contact) sellerContactIterator.next();			sellerContactView 	= new SellerContactView();			statusChanged		= false;									//Si la fecha de la cita se ha sobrepasado, dependiendo de si habia			//que realizar un pago se pone la cita como realizada o no realizada			//Si aún no se había contestado a la petición de cita se pone todo a not done			//El estado del voto se pone a pendiente			if( DBUtils.getTimeFrom( contact.getDateDate(), locale, false) <= 0) {				if ( contact.getPaymentStatusConst().intValue() == Constant.PAYMENT_STATUS_WAITING) {					contact.setPaymentStatusConst	( new Integer( Constant.PAYMENT_STATUS_NOT_DONE));					contact.setDateStatusConst		( new Integer( Constant.DATE_STATUS_NOT_DONE));					contact.setVoteStatusConst		( new Integer( Constant.VOTE_STATUS_WAITING));					contact.setSellerVoteStatusConst( new Integer( Constant.VOTE_STATUS_WAITING));					statusChanged = true;				}								if(( contact.getPaymentStatusConst().intValue() == Constant.PAYMENT_STATUS_DONE) ||				   ( contact.getPaymentStatusConst().intValue() == Constant.PAYMENT_STATUS_NOT_NEEDED)) { 						if( ( contact.getDateStatusConst().intValue() == Constant.DATE_STATUS_WAITING) || ( contact.getDateStatusConst().intValue() == Constant.DATE_STATUS_NA)) {							contact.setDateStatusConst( new Integer( Constant.DATE_STATUS_DONE));							statusChanged = true;						}												if( contact.getVoteStatusConst().intValue() == Constant.VOTE_STATUS_NA) {							contact.setVoteStatusConst		( new Integer( Constant.VOTE_STATUS_WAITING));							contact.setSellerVoteStatusConst( new Integer( Constant.VOTE_STATUS_WAITING));							statusChanged = true;						}				}								if( contact.getPaymentStatusConst().intValue() == Constant.PAYMENT_STATUS_NA){						contact.setMessageStatusConst( new Integer( Constant.MESSAGE_STATUS_NOT_REPLIED));						contact.setDateStatusConst( new Integer( Constant.DATE_STATUS_NOT_DONE));						contact.setPaymentStatusConst( new Integer( Constant.PAYMENT_STATUS_NOT_DONE));						contact.setVoteStatusConst		( new Integer( Constant.VOTE_STATUS_NA));						contact.setSellerVoteStatusConst( new Integer( Constant.VOTE_STATUS_NA));						statusChanged = true;												contact.getSeller().setContactsNotReplied( new Integer( contact.getSeller().getContactsNotReplied().intValue() + 1));						sellerDAO.setSeller( contact.getSeller());												contact.getBuyer().setContactsNotReplied( new Integer( contact.getBuyer().getContactsNotReplied().intValue() + 1));						buyerDAO.setBuyer( contact.getBuyer());				}												if( statusChanged == true)					contactDAO.setContact( contact);			}						ContactToSellerContactViewTranslator contactToSellerContactViewTranslator = new ContactToSellerContactViewTranslator();			contactToSellerContactViewTranslator.setLocale( locale);			contactToSellerContactViewTranslator.setObject( contact);						sellerContactView = ( SellerContactView) contactToSellerContactViewTranslator.translateView();						if( odd)				sellerContactView.setOddOrEven( "odd");			else				sellerContactView.setOddOrEven( "even");						odd = ! odd;						list.add( sellerContactView);					}					sellerContactDataView.setContacts( list);				return sellerContactDataView;	}	}